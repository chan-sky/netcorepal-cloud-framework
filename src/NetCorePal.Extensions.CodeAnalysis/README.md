# NetCorePal.Extensions.CodeAnalysis

## 代码流分析可视化

### 功能特性

**图中展示的元素：**
1. 发出命令的类型及其方法（如 Controller、事件处理器等）
2. 命令
3. 聚合及其方法（包括子实体方法）
4. 领域事件及其处理器
5. 集成事件及其处理器
6. 集成事件转换器

**展示的关系：**
1. 发出命令的方法 → 命令
2. 命令（即命令处理器）→ 聚合方法
3. 聚合方法 → 领域事件
4. 领域事件 → 集成事件转换器 → 集成事件
5. 领域事件 → 领域事件处理器
6. 集成事件 → 集成事件处理器

> 注：事件处理器发出命令时，不展示处理器方法节点（方法固定）。

---

### 可视化输出类型

框架提供三种主要的可视化图表：

#### 1. 架构总览图 (ArchitectureOverviewMermaidVisualizer)

- 在一张大图中展示所有节点和关系
- 提供系统架构的全局视图

#### 2. 处理流程图集合 (ProcessingFlowMermaidVisualizer)

- 生成所有独立业务处理链路的流程图集合（每个独立流程一张图）
- 任意无上游关系的节点（如 Controller 方法、事件处理器等）可作为链路起点
- 每条链路完整展示流程，节点可在多条链路中重复出现，保证链路完整性
- 用于展示命令、事件、聚合等在业务流转中的实际调用关系

#### 3. 聚合关系图集合 (AggregateRelationMermaidVisualizer)

- 生成所有聚合根的关系图集合（每个聚合根一张图）
- 展示每个聚合根相关的命令、事件、处理器等关系

---

### 子实体处理规则

- 子实体作为聚合属性时，视为聚合的子实体，方法归属聚合（如 `OrderItem.UpdateQuantity` 视为 `Order` 的方法）。
- 子实体方法、事件分别归属到所有引用它的聚合。
- 子实体发出的领域事件，归属为聚合方法发出的事件。
- 命令处理器调用子实体方法时，视为调用聚合方法。
- 聚合及子实体方法内部调用自身其它方法发出事件时，记录方法与事件的关系。

---

### 链路生成流程

**链路节点包括：**

- 发起命令的方法（类型+方法名）
- 命令
- 聚合方法（类型+方法名）
- 领域事件
- 集成事件转换器
- 领域事件处理器
- 集成事件处理器

**链路生成流程：**

1. 查找所有发出命令的方法，作为链路起点。
2. 若存在上游关系，则不作为起点。
3. 从起点递归查找下游关系，直到终点，构建完整链路。